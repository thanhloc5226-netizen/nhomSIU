{% extends 'base.html' %}
{% block body_block %}
{% load humanize %}

<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5>ğŸ’° Nháº­p sá»‘ tiá»n cho tá»«ng Ä‘á»£t thanh toÃ¡n</h5>
            <small>Há»£p Ä‘á»“ng: {{ contract.contract_no }} - GiÃ¡ trá»‹: {{ contract.contract_value|intcomma }} VNÄ</small>
        </div>
        
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}
                {{ formset.management_form }}
                
                <div class="alert alert-info">
                    <strong>ğŸ“Œ LÆ°u Ã½:</strong> Tá»•ng sá»‘ tiá»n cÃ¡c Ä‘á»£t nÃªn báº±ng {{ contract.contract_value|intcomma }} VNÄ
                    <br>
                    <strong>Tá»•ng hiá»‡n táº¡i:</strong> <span id="currentTotal">{{ current_total|intcomma }}</span> VNÄ
                </div>
                
               <div class="table-responsive">
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th width="5%">#</th>
                <th width="35%">Sá»‘ tiá»n (VNÄ) <span class="text-danger">*</span></th>
                <th width="30%">NgÃ y Ä‘áº¿n háº¡n</th>
                <th width="30%">Ghi chÃº</th>
            </tr>
        </thead>
        <tbody>
            {% for form in formset %}
            <tr {% if form.instance.is_paid %}class="table-success"{% endif %}>
                <td class="text-center align-middle">
                    {{ forloop.counter }}
                    {% if form.instance.is_paid %}
                        <br><small class="badge bg-success">âœ“ ÄÃ£ tráº£</small>
                    {% endif %}
                </td>
                <td>
                    {{ form.amount }}
                    {% if form.amount.errors %}
                        <div class="text-danger small">{{ form.amount.errors }}</div>
                    {% endif %}
                    {% if form.instance.paid_amount > 0 %}
                        <small class="text-muted d-block mt-1">
                            ÄÃ£ tráº£: {{ form.instance.paid_amount|floatformat:0|intcomma }} VNÄ
                        </small>
                    {% endif %}
                </td>
                <td>
                    {{ form.due_date }}
                    {% if form.due_date.errors %}
                        <div class="text-danger small">{{ form.due_date.errors }}</div>
                    {% endif %}
                </td>
                <td>
                    {{ form.notes }}
                </td>
                {{ form.id }}
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="table-warning">
                <td class="text-end"><strong>Tá»”NG:</strong></td>
                <td><strong id="totalAmount">-</strong></td>
                <td colspan="2"></td>
            </tr>
        </tfoot>
    </table>
</div>
                <div class="d-flex justify-content-between mt-3">
                    <a href="{% url 'contract_detail' contract.id %}" class="btn btn-secondary">â† Quay láº¡i</a>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ LÆ°u sá»‘ tiá»n</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// TÃ­nh tá»•ng khi nháº­p
document.addEventListener('DOMContentLoaded', function() {
    const amountInputs = document.querySelectorAll('input[name$="-amount"]');
    
    function calculateTotal() {
        let total = 0;
        amountInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        
        document.getElementById('totalAmount').textContent = total.toLocaleString('vi-VN') + ' VNÄ';
        document.getElementById('currentTotal').textContent = total.toLocaleString('vi-VN');
        
        // Äá»•i mÃ u náº¿u khÃ´ng khá»›p
        const contractValue = {{ contract.contract_value }};
        if (total === contractValue) {
            document.getElementById('totalAmount').style.color = 'green';
        } else {
            document.getElementById('totalAmount').style.color = 'red';
        }
    }
    
    amountInputs.forEach(input => {
        input.addEventListener('input', calculateTotal);
    });
    
    calculateTotal(); // TÃ­nh ngay khi load
});
</script>
{% endblock %}